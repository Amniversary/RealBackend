var imageMaxWidth = 750;
var imgSize;
$(function() {
	var t = function(t) {
			t && (t = t.substr(t.indexOf("?") + 1));
			for (var e = {}, i = t || location.search.substring(1), n = /([^&=]+)=([^&]*)/g, a; a = n.exec(i);) e[decodeURIComponent(a[1])] = decodeURIComponent(a[2]);
			return e
		},
		e = function(t, e, i) {
			var n = 0,
				a = 0,
				o = 1;
			return e >= t ? (o = i / e, e = i, t *= o, n = (i - t) / 2) : (o = i / t, t = i, e *= o, a = (i - e) / 2), {
				width: t,
				height: e,
				left: n,
				top: a
			}
		},
		i = {
			top: 0,
			left: 0
		},
		n = $("#generateBtn");
	initUploadModule = function() {
		var t = $("#fileIpt"),
			e = $("#sourceImg"),
			a = $("#g-wrap").width(),
			o = 1.495 * a,
			r = 0,
			d = $("#resizePicContainer"),
			c = $("#container"),
			s = $("#editArea"),
			l = $("#finishEditBtn"),
			h = $("#scaleRanger"),
			u = $("#uploadArea"),
			g = $("#cover"),
			f = $("#changeCurrentImgBtn"),
			p = $("#editBtn"),
			m = $("#previewImg"),
			v = $("#editImgSelect");
		c.css({
			width: a,
			height: o
		});
		var w = function(t, i) {
			//alert('onload');
			var n = new Image;
			n.onload = function() {
				e.data("oriwidth", this.width), e.data("oriheight", this.height), e.attr("src", n.src).show();
				var t = e.height(),
					i = e.width(),
					r = 0,
					d = 0,
					c = 1;
				o > t && (c = o / t, t = o, i = a * c, r = (i - a) / 2 * -1), t > o && (d = (t - o) / 2 * -1), e.css({
					width: i,
					height: t,
					left: r,
					top: d
				})
			}, n.src = t, d.show(), s.hide()
		};
		l.click(function() {
			var t = $("#sourceImg")[0].getClientRects()[0];
			i.left = t.left, i.top = t.top + $(document).scrollTop(), i.width = t.width, i.height = t.height, console.log($("#sourceImg")[0].getClientRects()[0]), console.log(i), d.hide(), s.show(), u.addClass("uploaded"), m.attr("src", e.attr("src")).show(), n.removeClass("disabled");
			if(e.width()<=e.height()){
				m.attr({"width": "100%", "height": "auto"});
			}else{
				m.attr({"height":"100%", "width": "auto"});
			}
			//console.log(i.top);
		}), f.click(function() {
			m.attr("src", "").hide(), u.removeClass("uploaded"), e[0].style.webkitTransform = "", h.val(1), n.addClass("disabled")
		}), p.click(function() {
			d.show(), s.hide()
		}), t.on("change", function(t) {
			//alert('changed');
			var e = t.target.files[0];
			e && EXIF.getData(t.target.files[0], function() {
				console.log("img:");
				
				imgSize = e.size/1024/1024;
				console.log(imgSize);
				var t = EXIF.getTag(this, "Orientation"),
					i = document.getElementById("mycanvas"),
					n = new MegaPixImage(e);
				n.render(i, {
					maxWidth: imageMaxWidth,
					orientation: t
				}), n.onrender = function() {
					//alert('rendered');
					var t = i.toDataURL("image/jpeg", 1);
					$("body").prepend('<img style="display: none;" id="realImage" src="' + t + '" >'), w(t)
				}
			})
		});
		var y = 1,
			x;
		h.on("input", function() {
			x = $(this).val(), e[0].style.webkitTransform = "scale(" + x + ")"
		});
		var I = $(".novel-list"),
			M = function(t) {
				var e = "";
				t.find("li").each(function() {
					e += $(this).text() + "\n"
				}), $("#descText").val(e)
			};
		$("#getWordsBtn").click(function() {
			var t = 39 * Math.random() >> 0;
			//console.log("random:"+t);
			M(I.eq(t))
		}), I.click(function() {
			M($(this))
		}), M(I.eq(39 * Math.random() >> 0))
	};
	var a = function() {
			var t = $("#container"),
				e = $("#sourceImg"),
				a = $("#container"),
				o = $("#scaleRanger"),
				r = "/mbliving/cut_img",
				d = a.width(),
				c = a.height(),
				s = imageMaxWidth / d,
				l = $("#verify"),
				h = $("#printerBtn"),
				u = function() {
					var n = new FormData,
						a = new XMLHttpRequest,
						c = t.width(),
						s = t.height(),
						l = e.data("oriheight"),//原图高
						h = e.data("oriwidth"),//原图宽
						u = e.width(),
						g = u / h,
						f = imageMaxWidth / d,
						p = e.offset();
						/*m = $("#descText").val().split("\n");
					m = $.map(m, function(t, e) {
						return $.trim(t)
					}), m = $.grep(m, function(t, e) {
						return t.length
					});
					for (var v = 0, w = m.length; w > v; v++){
						if (m[v].length > 15){
							console.log(m[v]);
							console.log(m[v].length);
							alert("我就是网红每句请不要超过15个字");return false;
						} 
					}
					if(m.length>6){
						return void alert("我就是网红请不要超过6行");return false;
					}
					console.log("测试");
					console.log(m);*/
					/*if(m.length>6){
						return void alert("我就是网红请不要超过16行");
					}*/
					//m = m.join(",");
					//alert($("#sourceImg").width());
					var y = {
						url: location.href,
						text: JSON.stringify(m),
						//text: $("#descText").val(),
						picture: $("#realImage").attr("src"),
						scale: o.val() * (u / h) * 2,
						//x: -1 * Math.round(i.left - 12) * 2,
						x: Math.round(($("#sourceImg").width()*o.val()-c)/2) * 2,
						//y: -1 * Math.round(i.top - 12) * 2,
						y: Math.round(($("#sourceImg").height()*o.val()-s)/2) * 2,
						width: 2 * Math.round(c),
						height: 2 * Math.round(s),
						screenWidth: document.documentElement.clientWidth
					};
					//alert(JSON.stringify(y));
					$.ajax({
						url: r,
						dataType: "json",
						type: "POST",
						data: y
					}).done(function(t) {
						//alert(JSON.stringify(y));
						//console.log(t), 0 == t.code ? t.result && (window.location.href = "result.html?imgurl=" + t.result + "&textword=" + JSON.stringify(m)) : alert(JSON.stringify(t))
						if(t.error_msg=="ok"){
							location.href = t.url
							//console.log(t);
						}
					}).fail(function() {
						//图片大小不能大于9MB
						alert("图片组合接口无响应")
					})
				};
				function verify(){
					m = $("#descText").val().split("\n");
					m = $.map(m, function(t, e) {
						return $.trim(t)
					}), m = $.grep(m, function(t, e) {
						return t.length
					});

					if(m.length==0){
						alert("宣言内容请不要少于1行");return false;
					}
					for (var v = 0, w = m.length; w > v; v++){
						if (m[v].length > 13){
							alert("宣言内容每句请不要超过13个字");return false;
						} 
					}
					if(m.length>6){
						return void alert("宣言内容请不要超过6行");return false;
					}
					if(imgSize>9){
						alert("图片大小请不要大于9MB");return false;
					}
					return true;
				}
			n.click(function() {
				if(verify()){
					n.hasClass("disabled") || (n.addClass("disabled"), n.find(".txt").html("正在生成，请稍后……").show().prev().hide(),u() )
				}
				
			});
			var g = $("#startBtn");
			g.click(function() {
				$("#indexPanel").hide(), $("#page2").show()
			})
		},
		o = function() {
			/*$.ajax({
				url: BIU.host + "/i_system_query/check_wechat_oauthurl",
				dataType: "json",
				type: "POST",
				data: {
					module: "projects/printer/index",
					keyword: "1"
				}
			}).done(function(t) {
				0 == t.code && t.result && (window.location.href = t.result), console.log(JSON.stringify(t))
			})*/
		},
		r = function() {
			initUploadModule(), a()
		};
	window.initApp = r, r()
});
