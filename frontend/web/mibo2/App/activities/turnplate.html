<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui" />
<meta http-equiv="Content-Security-Policy" content="default-src gap://ready file:; style-src 'self' 'unsafe-inline'; script-src 'unsafe-inline' 'unsafe-eval'">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection"content="telephone=no, email=no" />
<title>幸运大转盘</title>

<link href="css/turnplate.css" rel="stylesheet" type="text/css">
</head>
<body>
	<!--loading-->
	<div id="j_loading" class="loading">
	    <span class="bii"></span>
	</div>
	<div class="wrap" style="background:#ff574a;overflow-x:hidden;">
		<img src="http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/turnplate/index_bg.jpg" class="dw">
		<div class="imgs" id="j_imgs" style="display:none;">
			<img src="images/flower.png" id="flower-img"/>
		    <img src="images/experience.png" id="experience-img" style="display:none;" />
		    <img src="images/ipadmini4.png" id="ipadmini4-img" style="display:none;" />
		    <img src="images/kindle.png" id="kindle-img" style="display:none;" />
		    <img src="images/gift.png" id="gift-img" style="display:none;" />
		    <img src="images/iphone7.png" id="iphone7-img" style="display:none;" />
		</div>	    
	    <!--大转盘-->
		<div class="banner">
			<div class="turnplate" style="background-image:url(http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/turnplate/turnplate-bg1.png);background-size:100% 100%;">
				<canvas class="item" id="wheelcanvas" width="422px" height="422px"></canvas>
				<img class="pointer" src="http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/turnplate/turnplate-pointer1.png"/>
			</div>
		</div>
		<!--抽奖记录-->
		<div class="m-rules m-record" id="j_record_list" style="display:none;">
			<div class="tit">
				<img src="http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/turnplate/record.png" alt="抽奖记录">
				<h2>抽奖记录</h2>
			</div>
			<ul class="list">
				<!-- <li class="clearfix">
					<div class="avatar">
						<img src="images/avatar4.jpg" alt="">
					</div>
					<div class="info">
						<span>Anna 宝宝</span>
						<span class="date">9月24日</span>
					</div>
					<p>抽中&emsp;<span>经验值5000</span></p>
				</li> -->
			</ul>
		</div>
		<!--活动规则-->
		<div class="m-rules">
			<div class="tit">
				<img src="images/rules.png" alt="活动规则">
				<h2>活动规则</h2>
			</div>
			<div class="paras">
				<p>1:活动时间：10月1日-10月31日。</p>
				<p>2：凡微信端新注册用户均可获得一次抽奖机会，下载蜜播APP即可在本页面进行抽奖，中奖率100%。</p>
				<p>3：抽奖所得鲜花、经验值等奖品在参与活动完成后1-3个工作日到“我的账户”，实物礼物在活动结束后7个工作日根据中奖者预留的信息发送。</p>
				<p>4：大礼包的奖励为18朵鲜花，3000经验。</p>
				<p>5：有关活动问题请随时在微信公众号中联系蜜播客服进行咨询。</p>
				<p>6：活动最终解释权归蜜播直播。</p>
			</div>
		</div>
		<!--中奖弹窗-->
		<div class="alert" id="j_alert">
			<div class="wrap">
				<img src="images/alert_bg.png" alt="" class="dw">
				<div class="content">					
					<div class="tip">
						<img src="images/flower.png" alt="" class="p-img">
						<span class="p-name">鲜花</span>
						<span class="p-num">28朵</span>
					</div>
					<a href="javascript:;" class="btn" id="j_btn">宝宝知道了</a>
				</div>
			</div>
		</div>
	</div>

<script type="text/javascript" src="http://bmpic.matewish.cn/meibo-test/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../js/component/pop.js"></script>
<script type="text/javascript" src="js/awardRotate.js"></script>
<script type="text/javascript">
var turnplate={
		restaraunts:[],				//大转盘奖品名称
		colors:[],					//大转盘奖品区块对应背景颜色
		imgs:[],
		//outsideRadius:192,			//大转盘外圆的半径
		outsideRadius:161,
		//textRadius:155,				//大转盘奖品位置距离圆心的距离
		textRadius:90,	
		textRadius2:72,
		//insideRadius:68,			//大转盘内圆的半径
		insideRadius:10,
		startAngle:-Math.PI*5/8,				//开始角度		
		bRotate:false,				//false:停止;ture:旋转
		prizeJson:{},
		chance:0
};

$(document).ready(function(){
	//动态添加大转盘的奖品与奖品区域背景颜色
	$.ajax({
		url: "/mbliving/get_lucky_draw_info"+location.search,
		type: "get",
		async: false,
		success: function(data){
			data = JSON.parse(data);
			if(data.code == 1){
				popInfo(data.msg, 1);
			}
			var htmlStr = '';
			turnplate.chance = data.lucky_draw;
			$.each(data.prize_info, function(index, obj){
				turnplate.restaraunts.push(obj.gift_name);
				
				//处理礼物对应的图片，保存下来
				turnplate.imgs.push(obj.pic);
				htmlStr += '<img src="'+obj.pic+'" id="img-'+index+'" style="display:block;width:50%;"/>';
				turnplate.prizeJson[obj.grade] = index;
			})
			$("#j_imgs").html(htmlStr);
			console.log(turnplate.imgs);
			console.log(turnplate.restaraunts);
			console.log(turnplate.prizeJson);
			
			//如果有抽奖记录，显示抽奖记录
			var prize_record = "";
			if(data.user_info&&data.user_info.length>0){
				$.each(data.user_info, function(index, obj){
					if(obj.prize_name.indexOf("礼包")>=0){
						var arr = obj.prize_name.split(" ");
						obj.prize_name = arr[0];
						console.log(obj.prize_name);
					}

					prize_record += '<li class="clearfix">'+
					'<div class="avatar"><img src="'+obj.pic+'" alt=""></div>'+
					'<div class="info"><span>'+obj.nick_name+'</span><span class="date">'+obj.create_time.slice(0,obj.create_time.length-3)+'</span></div>'+
					'<p>抽中&ensp;<span>'+obj.prize_name+'</span></p></li>';
					
				})				
			}
			$("#j_record_list").show().find(".list").html(prize_record);
			
		},
		error: function(){
			alert("sorry, 服务器异常！");
		}
	})
	//turnplate.restaraunts = ["iphone7", "经验值 5000", "礼包", "鲜花 28朵", "kindle", "经验值 3000", "ipad mini4", "鲜花 14朵"];
	turnplate.colors = ["#f79c00", "#fff700", "#f79c00", "#fff700","#f79c00", "#fff700", "#f79c00", "#fff700"];
	turnplate.fontcolors = ["#fff", "#f79c00", "#fff", "#f79c00","#fff", "#f79c00", "#fff", "#f79c00"];
	//turnplate.imgs = ["http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/iphone7.png", "http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/experience.png", "http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/gift.png", "http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/flower.png", "http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/kindle.png", "http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/experience.png", "http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/ipadmini4.png", "images/flower.png"];
	var rotateTimeOut = function (){
		$('#wheelcanvas').rotate({
			angle:0,
			animateTo:2160,
			duration:1000,
			callback:function (){
				alert('网络超时，请检查您的网络设置！');
			}
		});
	};

	//旋转转盘 item:奖品位置; txt：提示语;
	var rotateFn = function (item, txt){
		var angles = item * (360 / turnplate.restaraunts.length) - (360 / (turnplate.restaraunts.length*2));
		if(angles<270){
			angles = 270 - angles; 
		}else{
			angles = 360 - angles + 270;
		}
		$('#wheelcanvas').stopRotate();
		$('#wheelcanvas').rotate({
			angle:0,
			animateTo:angles+1800-turnplate.startAngle*360/2/Math.PI,
			duration:8000,
			callback:function (){
				//alert(txt);
				var textArr = txt.split(" "),
					name = textArr[0],
					num = textArr[1]?textArr[1]:"",
					src = "";
				$("#j_alert .p-name").html(name);
				$("#j_alert .p-num").html(num);
				/*if(name.indexOf("礼包")>=0){
					src = "images/gift.png";
				}else if(name.indexOf("鲜花")>=0){
					src = "images/flower.png";
				}else if(name.indexOf("经验")>=0){
					src = "images/experience.png";
				}else if(name.indexOf("kindle")>=0){
					src = "images/kindle.png";
				}else if(name.indexOf("iphone7")>=0){
					src = "images/iphone7.png";
				}else if(name.indexOf("ipad")>=0){
					src = "images/ipadmini4.png";
				}*/
				//alert(item-1);

				src = $("#img-"+(item-1)).attr("src");
				$("#j_alert .p-img").attr("src", src);
				//显示中奖弹窗
				$("#j_alert").fadeIn(300);
				turnplate.bRotate = !turnplate.bRotate;
			}
		});
	};

	$('.pointer').click(function (){
		if(turnplate.bRotate)return;
		if(turnplate.chance==0){
			popInfo("抽奖次数已经用完了", 1);
			return;
		} 
		turnplate.bRotate = !turnplate.bRotate;
		//获取随机数(奖品个数范围内)
		//var item = rnd(1,turnplate.restaraunts.length);
		//获取中奖信息
		$.ajax({
			url: "/mbliving/do_activity_prize"+location.search,
			type: "get",
			async: false,
			success: function(data){
				data = JSON.parse(data);
				if(data.error_msg!="ok"){
					popInfo(data.error_msg, 1);
					turnplate.bRotate = !turnplate.bRotate;
				}else{
					item = data.activity_prize.grade;
					item =turnplate.prizeJson[item]+1;
					rotateFn(item, turnplate.restaraunts[item-1]);
					console.log(item);
				}
			}
		})
	});
});

function rnd(n, m){
	var random = Math.floor(Math.random()*(m-n+1)+n);
	return random;
	
}


//页面所有元素加载完毕后执行drawRouletteWheel()方法对转盘进行渲染
window.onload=function(){
	//隐藏loading
	$("#j_loading").hide();
	drawRouletteWheel();
	//点击宝宝知道了
	$("#j_btn").click(function(){
		$("#j_alert").fadeOut(300);
	})
	/*if(turnplate.chance==0){
		alert("抽奖次数已经用完了");
	}*/
};

function drawRouletteWheel() {    
  var canvas = document.getElementById("wheelcanvas");    
  if (canvas.getContext) {
	  //根据奖品个数计算圆周角度
	  var arc = Math.PI / (turnplate.restaraunts.length/2);
	  var ctx = canvas.getContext("2d");
	  //在给定矩形内清空一个矩形
	  ctx.clearRect(0,0,422,422);
	  //strokeStyle 属性设置或返回用于笔触的颜色、渐变或模式  
	  ctx.strokeStyle = "#FFBE04";
	  //font 属性设置或返回画布上文本内容的当前字体属性
	  ctx.font = '16px Microsoft YaHei';      
	  for(var i = 0; i < turnplate.restaraunts.length; i++) {       
		  var angle = turnplate.startAngle + i * arc;
		  ctx.fillStyle = turnplate.colors[i];
		  ctx.beginPath();
		  //arc(x,y,r,起始角,结束角,绘制方向) 方法创建弧/曲线（用于创建圆或部分圆）       
		  ctx.arc(211, 213, turnplate.outsideRadius, angle, angle + arc, false);    
		  ctx.arc(211, 213, turnplate.insideRadius, angle + arc, angle, true);
		  ctx.stroke();  
		  ctx.fill();
		  //锁画布(为了保存之前的画布状态)
		  ctx.save();   
		  
		  //----绘制奖品开始----
		  ctx.fillStyle = turnplate.fontcolors[i];
		  var text = turnplate.restaraunts[i];
		  var line_height = 22;
		  //translate方法重新映射画布上的 (0,0) 位置
			var textArr = text.split(" ");
		  if(textArr.length==1||text.indexOf("（")>=0||text.indexOf("(")>=0){
		  	//一排字或者有()
		  	ctx.translate(211 + Math.cos(angle + arc / 2) * turnplate.textRadius2, 211 + Math.sin(angle + arc / 2) * turnplate.textRadius2);
		  }else if(textArr.length==2){
		  	//两排字
		  	ctx.translate(211 + Math.cos(angle + arc / 2) * turnplate.textRadius, 211 + Math.sin(angle + arc / 2) * turnplate.textRadius);
		  } 
		  
		  
		  //rotate方法旋转当前的绘图
		  ctx.rotate(angle + arc / 2 + Math.PI / 2);
		  
		  /** 下面代码根据奖品类型、奖品名称长度渲染不同效果，如字体、颜色、图片效果。(具体根据实际情况改变) **/
		  if(text.indexOf(" ")>0){//鲜花、经验
			  var texts = text.split(" ");
			  for(var j = 0; j<texts.length; j++){
				  ctx.font = '18px Microsoft YaHei';				  
				  if(texts[j].indexOf("（")>=0||texts[j].indexOf("(")>=0){
				  	continue;
				  }
				  ctx.fillText(texts[j], -ctx.measureText(texts[j]).width / 2, j * line_height);
			  }
		  }else{
			  //在画布上绘制填色的文本。文本的默认颜色是黑色
			  //measureText()方法返回包含一个对象，该对象包含以像素计的指定字体宽度
			  ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
		  }
		  
		  //添加对应图标
		  /*var img= $("#img-"+i);
		  console.log(img); 
		  $("#img-"+i).on("load", function(){  
			  ctx.drawImage(img,-img.width/2,-img.height/2-43);     
		  });
		 img = img.get(0);
		  ctx.drawImage(img,-26,-76);  */
		 /* turnplate["img"+i] = new Image();
		  turnplate["img"+i].src = turnplate.imgs[i];
		  console.log();
		  (turnplate["img"+i].onload = function(){
		  	console.log("img"+i, turnplate["img"+i].width, turnplate["img"+i].height);
		  	//ctx.drawImage(img,-26,-76);  
		  	ctx.drawImage(turnplate["img"+i],-turnplate["img"+i].width/2,-turnplate["img"+i].height/2-43); 
		  })();
		  //(function(i){
		  	
		  //})(i);*/
/*var img= $imgList.find("#img-"+i).get(0);
		  img.onload=function(){  
			  ctx.drawImage(img,-img.width/2,-img.height/2-43);       
		  };
		  ctx.drawImage(img,-img.width/2,-img.height/2-43); */ 
		  img= document.getElementById("img-"+i);
		  img.onload=function(){  
			  ctx.drawImage(img,-img.width/2,-img.height/2-47);       
		  };
		  ctx.drawImage(img,-img.width/2,-img.height/2-47);
		  /*if(text.indexOf("礼包")>=0){
			  var img= document.getElementById("gift-img");
		  img.onload=function(){  
			  ctx.drawImage(img,-26,-76);     
		  };  
		  ctx.drawImage(img,-26,-76);
		  }else if(text.indexOf("鲜花")>=0){
			  var img= document.getElementById("flower-img");
			  img.onload=function(){  
				  ctx.drawImage(img,-25,-70);     
			  }; 
			  ctx.drawImage(img,-25,-70);  
		  }else if(text.indexOf("经验")>=0){
			  var img= document.getElementById("experience-img");
			  img.onload=function(){  
				  ctx.drawImage(img,-25,-68);     
			  };  
			  ctx.drawImage(img,-25,-68); 
		  }else if(text.indexOf("ipad")>=0){
			  var img= document.getElementById("ipadmini4-img");
			  img.onload=function(){  
				  ctx.drawImage(img,-34,-62);     
			  };  
			  ctx.drawImage(img,-34,-62); 
		  }else if(text.indexOf("iphone7")>=0){
			  var img= document.getElementById("iphone7-img");
			  img.onload=function(){  
				  ctx.drawImage(img,-15,-78);     
			  };  
			  ctx.drawImage(img,-15,-78); 
		  }else if(text.indexOf("kindle")>=0){
			  var img= document.getElementById("kindle-img");
			  img.onload=function(){  
				  ctx.drawImage(img,-22,-78);     
			  };  
			  ctx.drawImage(img,-22,-78); 
		  }*/
		  //把当前画布返回（调整）到上一个save()状态之前 
		  ctx.restore();
		  //----绘制奖品结束----
	  }     
  } 
}

</script>	
</body>
</html>