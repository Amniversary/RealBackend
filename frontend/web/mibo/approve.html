<!DOCTYPE html>
<html>

<head>	
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection"content="telephone=no, email=no" />
	<title>蜜播认证</title>
	<link rel="stylesheet" href="css/weixin/style.css">
	<style>
	.btn-green{
		line-height: 44px;
	}
	.btn-sm{
		line-height: 28px;
	}
	.ceil{
		display: none;
	}
	.add-img{
		position: relative;
		display: inline-block;
		margin: 0 auto;
	}
	.p-verify .addImgs{
		margin:0;
		padding:0 4.5% 10px;
		background-color: #fff;
	}
	.p-verify .addImgs>li{
		margin:0;
		padding:0 1%;
	}
	#aaa ~ *{
                display: none;
            }
    .refer-alert{
    	position: fixed;
    	top: 0;
    	left: 0;
    	width: 100%;
    	height: 100%;
    	background: rgba(0,0,0,.5);
    	z-index: 9999;
    	display: none;
    }
    .refer-alert img{
    	position: absolute;
    	top: 50%;
    	left: 50%;
    	width: 100%;
    	-webkit-transform: translate(-50%, -80%);
    }
	</style>
</head>

<body class="p-verify">	
	<form class="form" id="j_form">
		<div class="ipt-box">
			<span>真实姓名</span>
			<input type="text" placeholder="输入真实姓名" name="actual_name">
		</div>
		<div class="ipt-box" id="id_card">
			<span>身份证号</span>	
			<input type="text" onkeyup="value=value.replace(/[^\w\.\/]/ig,'')" placeholder="输入身份证号" oninput="checkTextLength( this , 18)" name="id_card" class="id_card">
		</div>
		<div class="tips bg-grey">
			<p>*小蜜提示：为了保护您的合法权益，请您如实填写以上信息（均为必填），我们的工作人员会在第一时间对您的申请进行审核处理，通过后您就可以发起直播啦！<!-- 银行账户信息必须与您本人（即开户人）姓名、手机号码完全一致，否则将导致您的申请无法通过。 --></p>
		</div>
		<div class="submit bg-grey">
			<input type="button" value="提交申请" class="btn-yellow" id="j_submit">
		</div>	
	</form>

	<!--跟plupload有关的dom结构部分-->
	<div style="display:none;">
		<h4>您所选择的文件列表：</h4>
		<div id="ossfile">你的浏览器不支持flash,Silverlight或者HTML5！</div>
		<div id="container">
			<a id="selectfiles" href="javascript:void(0);" class='btn'>选择文件</a>
			<a id="postfiles" href="javascript:void(0);" class='btn'>开始上传</a>
		</div>
	    <form name="theform">
			<input type="radio" name="myradio" value="local_name"/>上传文件名字保持本地文件名字
			<input type="radio" name="myradio" value="random_name" checked=true/>上传文件名字是随机文件名, 后缀保留
		</form>
	</div>
	<!--图片上传中-自定义进度条-->
	<span class="ceil" id="j_progress">
        <div class="loader loader-green duration-3s-before">
            <a href="javascript:;">100%</a>
        </div>
    </span>
    <!--参考照片弹窗-->
    <div class="refer-alert" id="j_refer_alert">
    	<img src="http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/refer_to.png" alt="">
    </div>
	<script src="http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/js/jquery-2.0.3.min.js"></script>
	<script src="http://mblive.oss-cn-hangzhou.aliyuncs.com/mblive/js/backbone_underscore.js"></script>
	<!--自定义弹窗组件-->
	<script src="js/component/pop.js"></script>
	<!--跟上传图片有关-->
	<script src="js/libs/plupload/plupload.full.min.js"></script>
	<script src="js/pages/approve/upload.js"></script>
	<script id="aaa">

	var $curEle;

	function checkTextLength(obj, length) {   
    
           if(obj.value.length > length)   {   
                
	               obj.value = obj.value.substr(0, length);   
	           }   
		   
	}

	$('#id_card').on('input',function(){ 
		$(".id_card").val($(".id_card").val().replace(/[^\w\.\/]/ig,'')) 
	})

	window.onload = function(){


		//点击参考照片
		$("#j_refer").on('touchstart', function(){
			$("#j_refer_alert").show();
		})
		$("#j_refer_alert").on('touchstart', function(){
			$(this).hide();
		})
		//设置图片容器的高度
		var imgWidth = $('.add-img').width();
		$('.add-img').css('height', imgWidth+1); 
		$('.add-img').css('width', imgWidth); 
		$('.add-img img').css({
			'position': 'absolute',
			'left': '50%',
			'top': '50%',
			'-webkit-transform': 'translate(-50%, -50%)'
		})
		//点击上传图片
		
		$('.add-img').on('click',function(){
			$('.moxie-shim input').click();
			$curEle = $(this).parents('li');
		}) 

		app_id = getUrlParam('app_id');
		rand_str = getUrlParam('rand_str');
		time = getUrlParam('time');
		unique_no = getUrlParam('unique_no');
		p_sign = getUrlParam('p_sign');

		//蜜播特别版ID
		if(app_id == 1172645364  || app_id == 1177913201)
		{
			$('.btn-yellow').css('background-color','#fc5176');
		}

		function getUrlParam(name){
			var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
			var r = window.location.search.substr(1).match(reg); //匹配目标参数
			if (r != null) return unescape(r[2]);
			return null; //返回参数值
		}

     
      	//获取验证码
      	$('#j_get').on('touchstart',function(){
      		var $ele = $(this),
      			phone_num = $('[name=phone_num]').val().trim();
      		if(/^(13|14|15|18)[0-9]{9}$/.test(phone_num)){
      			$.ajax({
	      			url: '/mbliving/livingsendverify',
	      			type: 'POST',
	      			data: {
	      				phone_num: phone_num
	      			},
	      			success: function(data){
	      				data = data&&JSON.parse(data);
	      				if(data.error_msg=='ok'){
	      					//已成功发送
	      					countDown($ele);
	      				}else{
	      					//error
	      					popInfo(data.error_msg, 1);
	      				}
	      			}
	      		})
      		}else if(phone_num!=''){
      			popInfo('请输入正确的手机号码', 1);
      		}else{
      			popInfo('请输入手机号码哦', 1);
      		}    		
      	})
      	var timer,
      		wait = 59,
      		$ele = $('#j_get');
      	function countDown(){	      		
			if (wait == 0) { 
				$ele.attr("disabled", false); 
				$ele.val("重新获取"); 
				wait = 59; 
				clearTimeout(timer);
			} else { 
				$ele.attr("disabled", true); 
				$ele.val(wait + "s"); 
				wait--; 
				timer = setTimeout(countDown, 1000);
			} 
      	}
	   

	    var Person = Backbone.Model.extend({
	    	url: '/mbliving/livingapprove',
	    	defaults: {
	    		'actual_name': '', //真实姓名
	    		'id_card': '', //身份证号码
	    	},
	    	validate: function(model){
	    		//真实姓名
	    		if(model.actual_name==''){
	    			return "真实姓名不能为空哦";
	    		}else{
	    			var reg = /^[\u4e00-\u9fa5]{2,6}$/;
	    			if(!reg.test(model.actual_name)){
	    				return "请输入正确的真实姓名";
	    			}
	    		}
	    		//身份证号码
	    		if(model.id_card==''){
	    			return "身份证号码不能为空哦";
	    		}else{
	    			console.log(model.id_card.length);
	    			//1、15位或18位，如果是15位，必需全是数字。
	    			//2、如果是18位，最后一位可以是数字或字母Xx，其余必需是数字。
	    			var reg = /^[1-9]\\d{5}[1-9]\\d{3}((0\\d)|(1[0-2]))(([0|1|2]\\d)|3[0-1])\\d{3}([0-9]|X)$/;
	    			var reg1 = /^[1-9]\\d{7}((0\\d)|(1[0-2]))(([0|1|2]\\d)|3[0-1])\\d{3}$/;
	    			if(!reg.test(model.id_card)){
	    				return "请输入正确的身份证号码";
	    			}
	    			if(!reg1.test(model.id_card)){
	    				return "请输入正确的身份证号码";
	    			}
	    		}

	    		if(model.p_sign==''){
	    			return "缺少签名";
	    		}
	    		if(model.unique_no==''){
	    			return "缺少用户唯一号";
	    		}
	    		if(model.rand_str==''){
	    			return "缺少随机字符串";
	    		}
	    		if(model.time==''){
	    			return "缺少时间戳";
	    		}
	    	}
	    })
	    var PersonView = Backbone.View.extend({
	    	el: $('#j_form'),
	    	events: {
	    		'touchstart #j_submit' :'submitForm'
	    	},
	    	initialize: function(){
	    		this.model = new Person();
	    		this.listenTo(this.model, 'invalid', this.alertErrorMsg);

	    	},
	    	submitForm: function(){
	    		//alert('submit');
	    		this.getFormInfo();
	    		
	    		//获取url中有用的参数	    		
	    		this.model.set({
	    			rand_str: rand_str,
    				time: time,
    				unique_no: unique_no,
    				p_sign: p_sign,
    				app_id:app_id
	    		})
	    		
	    		this.model.save({},{
	    			success: function(model, res) {
	    				//alert('success');
	    				//alert('success:'+JSON.stringify(res));
	    				if(res.error_msg=="ok"){
	    					popInfo(res.error_msg, 0);
	    					setTimeout(function(){
								window.location.href='approve_success.html';
	    					},2000)
	    					window.ApproveWebView.onsuccess();//通知app成功的消息
	    					
	    				}else{
	    					popInfo(res.error_msg, 1);
	    				}	      				
			        }
	    		});

	    	},
	    	getFormInfo: function(){
	    		var jsonArr = $('#j_form').serializeArray();//将提交的表单元素的值编译成拥有name和value对象组成的数组
	    		var _this = this;
	    		_.each(jsonArr,function(obj, index){
	    			_this.model.set(obj.name, obj.value);	    			
	    		})
	    		//alert(_this.model.get('actual_name'));
	    	},
	    	alertErrorMsg: function(model, error){
	    		popInfo(error,1);
	    	},
	    }) 
	    var personView = new PersonView();
	  }
    </script>
</body>

</html>